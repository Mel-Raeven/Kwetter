AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Resources:
  KwetterEventBus:
    Type: AWS::Events::EventBus
    Properties:
      Name:
        Fn::Sub: ${AWS::StackName}-KwetterEventBus
  KwetterEventBusDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName:
        Fn::Sub: ${AWS::StackName}-KwetterEventBusDLQ
  KwetterEventBusDLQPolicy:
    Type: AWS::SQS::QueuePolicy
    Properties:
      Queues:
      - Ref: KwetterEventBusDLQ
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal: '*'
          Action: sqs:SendMessage
          Resource:
            Fn::GetAtt:
            - KwetterEventBusDLQ
            - Arn
          Condition:
            ArnEquals:
              aws:SourceArn:
                Fn::GetAtt:
                - KwetterEventBus
                - Arn
  KwetterEventBusDLQRule:
    Type: AWS::Events::Rule
    Properties:
      Name:
        Fn::Sub: ${AWS::StackName}-KwetterEventBusDLQRule
      EventBusName:
        Ref: KwetterEventBus
      EventPattern:
        source:
        - com.example.kwetter
      Targets:
      - Id: KwetterEventBusDLQTarget
        Arn:
          Fn::GetAtt:
          - KwetterEventBusDLQ
          - Arn
        RetryPolicy:
          MaximumRetryAttempts: 1
          MaximumEventAgeInSeconds: 60
        DeadLetterConfig:
          Arn:
            Fn::GetAtt:
            - KwetterEventBusDLQ
            - Arn
  messageContentCheckingFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: go1.x
      SamResourceId: messageContentCheckingFunction
    Properties:
      FunctionName:
        Fn::Sub: ${AWS::StackName}-MessageContentCheckingFunction
      CodeUri: messageContentCheckingFunction
      Handler: bootstrap
      Runtime: provided.al2
      Architectures:
      - arm64
      Role:
        Fn::GetAtt:
        - messageContentCheckingFunctionRole
        - Arn
  messageContentCheckingFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: lambda.amazonaws.com
          Action: sts:AssumeRole
      Policies:
      - PolicyName:
          Fn::Sub: ${AWS::StackName}-LambdaLoggingPolicy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
            Resource: arn:aws:logs:*:*:*
      - PolicyName:
          Fn::Sub: ${AWS::StackName}-EventBridgePutEventsPolicy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action: events:PutEvents
            Resource:
              Fn::GetAtt:
              - KwetterEventBus
              - Arn
  DeleteUserFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: go1.x
      SamResourceId: DeleteUserFunction
    Properties:
      FunctionName:
        Fn::Sub: ${AWS::StackName}-DeleteUserFunction
      CodeUri: DeleteUserFunction
      Handler: bootstrap
      Runtime: provided.al2
      Architectures:
      - arm64
      Role:
        Fn::GetAtt:
        - DeleteUserFunctionRole
        - Arn
  DeleteUserFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: lambda.amazonaws.com
          Action: sts:AssumeRole
      Policies:
      - PolicyName:
          Fn::Sub: ${AWS::StackName}-CognitoDeleteUserPolicy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - cognito-idp:AdminDeleteUser
            - cognito-idp:GetUser
            Resource:
              Fn::GetAtt:
              - KwetterUserPool
              - Arn
      - PolicyName:
          Fn::Sub: ${AWS::StackName}-EventBridgePutEventsPolicy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action: events:PutEvents
            Resource:
              Fn::GetAtt:
              - KwetterEventBus
              - Arn
  MessageCreateFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: go1.x
      SamResourceId: MessageCreateFunction
    Properties:
      FunctionName:
        Fn::Sub: ${AWS::StackName}-MessageCreateFunction
      CodeUri: MessageCreateFunction
      Handler: bootstrap
      Runtime: provided.al2
      Architectures:
      - arm64
      Role:
        Fn::GetAtt:
        - MessageCreateFunctionRole
        - Arn
      Environment:
        Variables:
          TABLE_NAME:
            Fn::Sub: ${AWS::StackName}-KwetterMessagesDynamoDBTable
  MessageCreateFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: lambda.amazonaws.com
          Action: sts:AssumeRole
      Policies:
      - PolicyName:
          Fn::Sub: ${AWS::StackName}-LambdaLoggingPolicy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
            Resource: arn:aws:logs:*:*:*
      - PolicyName:
          Fn::Sub: ${AWS::StackName}-DynamoDBWritePolicy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action: dynamodb:PutItem
            Resource:
              Fn::GetAtt:
              - KwetterMessagesDynamoDBTable
              - Arn
  MessageDeleteBulkFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: go1.x
      SamResourceId: MessageDeleteBulkFunction
    Properties:
      FunctionName:
        Fn::Sub: ${AWS::StackName}-MessageDeleteBulkFunction
      CodeUri: MessageDeleteBulkFunction
      Handler: bootstrap
      Runtime: provided.al2
      Architectures:
      - arm64
      Role:
        Fn::GetAtt:
        - MessageDeleteBulkFunctionRole
        - Arn
  MessageDeleteBulkFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: lambda.amazonaws.com
          Action: sts:AssumeRole
      Policies:
      - PolicyName:
          Fn::Sub: ${AWS::StackName}-LambdaLoggingPolicy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
            Resource: arn:aws:logs:*:*:*
      - PolicyName:
          Fn::Sub: ${AWS::StackName}-DynamoDBWritePolicy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - dynamodb:DeleteItem
            - dynamodb:Scan
            - dynamodb:BatchWriteItem
            Resource:
              Fn::GetAtt:
              - KwetterMessagesDynamoDBTable
              - Arn
  MessageReadFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: go1.x
      SamResourceId: MessageReadFunction
    Properties:
      FunctionName:
        Fn::Sub: ${AWS::StackName}-MessageReadFunction
      CodeUri: MessageReadFunction
      Handler: bootstrap
      Runtime: provided.al2
      Architectures:
      - arm64
      Role:
        Fn::GetAtt:
        - MessageReadFunctionRole
        - Arn
  MessageReadFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: lambda.amazonaws.com
          Action: sts:AssumeRole
      Policies:
      - PolicyName:
          Fn::Sub: ${AWS::StackName}-LambdaDynamoDBPolicy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
            Resource: arn:aws:logs:*:*:*
          - Effect: Allow
            Action:
            - dynamodb:Query
            Resource:
            - Fn::GetAtt:
              - KwetterMessagesDynamoDBTable
              - Arn
  KwetterMessagesDynamoDBTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: ${AWS::StackName}-KwetterMessagesDynamoDBTable
      AttributeDefinitions:
      - AttributeName: UserID
        AttributeType: S
      - AttributeName: GUID
        AttributeType: S
      KeySchema:
      - AttributeName: UserID
        KeyType: HASH
      - AttributeName: GUID
        KeyType: RANGE
      ProvisionedThroughput:
        ReadCapacityUnits: 5
        WriteCapacityUnits: 5
  ReadCapacityScalableTarget:
    Type: AWS::ApplicationAutoScaling::ScalableTarget
    Properties:
      MaxCapacity: 100
      MinCapacity: 5
      ResourceId:
        Fn::Sub: table/${KwetterMessagesDynamoDBTable}
      RoleARN:
        Fn::GetAtt:
        - DynamoDBAutoScalingRole
        - Arn
      ScalableDimension: dynamodb:table:ReadCapacityUnits
      ServiceNamespace: dynamodb
  ReadCapacityScalingPolicy:
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Properties:
      PolicyName: ReadCapacityScalingPolicy
      PolicyType: TargetTrackingScaling
      ScalingTargetId:
        Ref: ReadCapacityScalableTarget
      TargetTrackingScalingPolicyConfiguration:
        TargetValue: 70.0
        PredefinedMetricSpecification:
          PredefinedMetricType: DynamoDBReadCapacityUtilization
        ScaleInCooldown: 60
        ScaleOutCooldown: 60
  WriteCapacityScalableTarget:
    Type: AWS::ApplicationAutoScaling::ScalableTarget
    Properties:
      MaxCapacity: 5000
      MinCapacity: 5
      ResourceId:
        Fn::Sub: table/${KwetterMessagesDynamoDBTable}
      RoleARN:
        Fn::GetAtt:
        - DynamoDBAutoScalingRole
        - Arn
      ScalableDimension: dynamodb:table:WriteCapacityUnits
      ServiceNamespace: dynamodb
  WriteCapacityScalingPolicy:
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Properties:
      PolicyName: WriteCapacityScalingPolicy
      PolicyType: TargetTrackingScaling
      ScalingTargetId:
        Ref: WriteCapacityScalableTarget
      TargetTrackingScalingPolicyConfiguration:
        TargetValue: 70.0
        PredefinedMetricSpecification:
          PredefinedMetricType: DynamoDBWriteCapacityUtilization
        ScaleInCooldown: 0
        ScaleOutCooldown: 60
  DynamoDBAutoScalingRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: application-autoscaling.amazonaws.com
          Action: sts:AssumeRole
      Policies:
      - PolicyName: DynamoDBAutoScalingPolicy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - dynamodb:DescribeTable
            - dynamodb:UpdateTable
            - cloudwatch:PutMetricAlarm
            - cloudwatch:DescribeAlarms
            - cloudwatch:GetMetricStatistics
            - cloudwatch:SetAlarmState
            - cloudwatch:DeleteAlarms
            Resource: '*'
  KwetterAPIGateway:
    Type: AWS::Serverless::Api
    Properties:
      StageName: Prod
      Cors: '''*'''
      Auth:
        DefaultAuthorizer: CognitoAuthorizer
        Authorizers:
          CognitoAuthorizer:
            UserPoolArn:
              Fn::Sub: arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/${KwetterUserPool}
            Identity:
              Header: Authorization
      DefinitionBody:
        swagger: '2.0'
        info:
          title: KwetterAPIGateway
        paths:
          /postMessage:
            post:
              consumes:
              - application/json
              produces:
              - application/json
              parameters: []
              responses:
                '200':
                  description: 200 response
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${messageContentCheckingFunction.Arn}/invocations
                passthroughBehavior: WHEN_NO_MATCH
                responses:
                  default:
                    statusCode: '200'
                  4xx:
                    statusCode: '400'
                  5xx:
                    statusCode: '500'
          /getMessages/{userid}:
            get:
              consumes:
              - application/json
              produces:
              - application/json
              parameters:
              - name: userid
                in: path
                required: true
                type: string
              responses:
                '200':
                  description: 200 response
              x-amazon-apigateway-integration:
                type: aws_proxy
                httpMethod: GET
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${MessageReadFunction.Arn}/invocations
                passthroughBehavior: WHEN_NO_MATCH
                responses:
                  default:
                    statusCode: '200'
                  4xx:
                    statusCode: '400'
                  5xx:
                    statusCode: '500'
                requestParameters:
                  integration.request.path.userid: method.request.path.userid
  OptionsMethodAuthorization:
    Type: AWS::ApiGateway::GatewayResponse
    Properties:
      ResponseParameters:
        gatewayresponse.header.Access-Control-Allow-Origin: '''*'''
        gatewayresponse.header.Access-Control-Allow-Methods: '''POST,OPTIONS'''
        gatewayresponse.header.Access-Control-Allow-Headers: '''Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'''
        gatewayresponse.header.Access-Control-Expose-Headers: '''Last-Evaluated-Key'''
      ResponseType: DEFAULT_4XX
      RestApiId:
        Ref: KwetterAPIGateway
      StatusCode: 200
  KwetterUserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName:
        Fn::Sub: ${AWS::StackName}-KwetterUserPool
      Policies:
        PasswordPolicy:
          RequireLowercase: true
          RequireSymbols: false
          RequireNumbers: true
          MinimumLength: '8'
          RequireUppercase: true
      UsernameAttributes:
      - email
      Schema:
      - AttributeDataType: String
        Name: email
        Required: false
      AutoVerifiedAttributes:
      - email
  KwetterUserpoolDomain:
    Type: AWS::Cognito::UserPoolDomain
    Properties:
      UserPoolId:
        Ref: KwetterUserPool
      Domain:
        Fn::Sub: ${AWS::StackName}
  KwetterUserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      UserPoolId:
        Ref: KwetterUserPool
      ClientName:
        Fn::Sub: ${AWS::StackName}-KwetterUserPoolClient
      GenerateSecret: false
      AllowedOAuthFlowsUserPoolClient: true
      AllowedOAuthFlows:
      - code
      - implicit
      ExplicitAuthFlows:
      - ALLOW_USER_PASSWORD_AUTH
      - ALLOW_REFRESH_TOKEN_AUTH
      - ALLOW_USER_SRP_AUTH
      CallbackURLs:
      - http://localhost:5173/auth/callback
      LogoutURLs:
      - http://localhost:5173/
      SupportedIdentityProviders:
      - COGNITO
      AllowedOAuthScopes:
      - phone
      - email
      - openid
      - profile
  KwetterAPIGatewayPermissionMessageContentCheckingFunction:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Fn::GetAtt:
        - messageContentCheckingFunction
        - Arn
      Principal: apigateway.amazonaws.com
  KwetterAPIGatewayPermissionMessageReadFunction:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Fn::GetAtt:
        - MessageReadFunction
        - Arn
      Principal: apigateway.amazonaws.com
  APIGatewayMessageContentEventRule:
    Type: AWS::Events::Rule
    Properties:
      EventBusName:
        Ref: KwetterEventBus
      EventPattern:
        source:
        - api.gateway
        detail-type:
        - API Gateway Request
      Targets:
      - Arn:
          Fn::GetAtt:
          - messageContentCheckingFunction
          - Arn
        Id: InvokeTestFunction
  APIGatewayMessageReadEventRule:
    Type: AWS::Events::Rule
    Properties:
      EventBusName:
        Ref: KwetterEventBus
      EventPattern:
        source:
        - api.gateway
        detail-type:
        - API Gateway Request
      Targets:
      - Arn:
          Fn::GetAtt:
          - MessageReadFunction
          - Arn
        Id: InvokeMessageReadFunction
  EventRulePermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Fn::GetAtt:
        - MessageCreateFunction
        - Arn
      Principal: events.amazonaws.com
      SourceArn:
        Fn::GetAtt:
        - messageContentCheckingFunctionEventRule
        - Arn
  messageContentCheckingFunctionEventRule:
    Type: AWS::Events::Rule
    Properties:
      EventBusName:
        Ref: KwetterEventBus
      EventPattern:
        detail-type:
        - MessageCreation
      Targets:
      - Arn:
          Fn::GetAtt:
          - MessageCreateFunction
          - Arn
        Id: MessageCreateFunction
        RetryPolicy:
          MaximumRetryAttempts: 4
          MaximumEventAgeInSeconds: 60
        DeadLetterConfig:
          Arn:
            Fn::GetAtt:
            - KwetterEventBusDLQ
            - Arn
  messageDeleteBulkEventRulePermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Fn::GetAtt:
        - MessageDeleteBulkFunction
        - Arn
      Principal: events.amazonaws.com
      SourceArn:
        Fn::GetAtt:
        - messageDeleteBulkFunctionEventRule
        - Arn
  messageDeleteBulkFunctionEventRule:
    Type: AWS::Events::Rule
    Properties:
      EventBusName:
        Ref: KwetterEventBus
      EventPattern:
        detail-type:
        - DeleteUser
      Targets:
      - Arn:
          Fn::GetAtt:
          - MessageDeleteBulkFunction
          - Arn
        Id: MessageDeleteBulkFunction
        RetryPolicy:
          MaximumRetryAttempts: 4
          MaximumEventAgeInSeconds: 120
        DeadLetterConfig:
          Arn:
            Fn::GetAtt:
            - KwetterEventBusDLQ
            - Arn
  KwetterDashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName:
        Fn::Sub: ${AWS::StackName}-KwetterDashboard
      DashboardBody: "{\n  \"widgets\": [\n    {\n      \"type\": \"metric\",\n  \
        \    \"x\": 0,\n      \"y\": 0,\n      \"width\": 6,\n      \"height\": 6,\n\
        \      \"properties\": {\n        \"metrics\": [\n          [ \"AWS/Lambda\"\
        , \"Errors\", { \"label\": \"Errors\", \"id\": \"errors\" } ],\n         \
        \ [ \".\", \"Invocations\", { \"label\": \"Invocations\", \"id\": \"invocations\"\
        \ } ],\n          [ \".\", \"Duration\", { \"label\": \"Duration\", \"id\"\
        : \"duration\" } ]\n        ],\n        \"period\": 300,\n        \"stat\"\
        : \"Sum\",\n        \"region\": \"eu-central-1\",\n        \"title\": \"Lambda\
        \ Metrics\"\n      }\n    },\n    {\n      \"type\": \"metric\",\n      \"\
        x\": 6,\n      \"y\": 0,\n      \"width\": 6,\n      \"height\": 6,\n    \
        \  \"properties\": {\n        \"metrics\": [\n          [\n            \"\
        AWS/Cognito\", \n            \"SignInSuccesses\", \n            \"UserPool\"\
        , \n            \"eu-central-1_sDUO5HFwX\", \n            \"UserPoolClient\"\
        , \n            \"5vs4anjqtme5f93037vv30fmp0\", \n            { \"label\"\
        : \"SignInSuccesses\", \"id\": \"signinsuccesses\" }\n          ],\n     \
        \     [\n            \"AWS/Cognito\", \n            \"SignUpSuccesses\", \n\
        \            \"UserPool\", \n            \"eu-central-1_sDUO5HFwX\", \n  \
        \          \"UserPoolClient\", \n            \"5vs4anjqtme5f93037vv30fmp0\"\
        , \n            { \"label\": \"SignUpSuccesses\", \"id\": \"signupsuccesses\"\
        \ }\n          ]\n        ],\n        \"period\": 300,\n        \"stat\":\
        \ \"Sum\",\n        \"region\": \"eu-central-1\",\n        \"title\": \"Cognito\
        \ SignIn Metrics\"\n      }\n    },\n    {\n      \"type\": \"metric\",\n\
        \      \"x\": 12,\n      \"y\": 0,\n      \"width\": 6,\n      \"height\"\
        : 6,\n      \"properties\": {\n        \"metrics\": [\n          [\n     \
        \       \"AWS/ApiGateway\", \n            \"Latency\", \n            \"ApiName\"\
        , \n            \"KwetterAPIGateway\", \n            { \"label\": \"Latency\"\
        , \"id\": \"latency\" }\n          ],\n          [\n            \"AWS/ApiGateway\"\
        ,\n            \"IntegrationLatency\", \n            \"ApiName\", \n     \
        \       \"KwetterAPIGateway\", \n            { \"label\": \"IntegrationLatency\"\
        , \"id\": \"integrationlatency\" }\n          ]\n        ],\n        \"period\"\
        : 300,\n        \"stat\": \"Sum\",\n        \"region\": \"eu-central-1\",\n\
        \        \"title\": \"API gateway Metrics\"\n      }\n    },\n    {\n    \
        \  \"type\": \"metric\",\n      \"x\": 18,\n      \"y\": 0,\n      \"width\"\
        : 6,\n      \"height\": 6,\n      \"properties\": {\n        \"metrics\":\
        \ [\n          [\n            \"AWS/DynamoDB\", \n            \"SuccessfulRequestLatency\"\
        , \n            \"TableName\", \n            \"KwetterMessagesDynamoDBTable\"\
        ,\n            \"Operation\",\n            \"Scan\",\n            { \"label\"\
        : \"SuccessfulRequestLatency\", \"id\": \"successfulrequestlatency\" }\n \
        \         ],\n          [\n            \"AWS/DynamoDB\", \n            \"\
        ReturnedItemCount\", \n            \"TableName\", \n            \"KwetterMessagesDynamoDBTable\"\
        ,\n            \"Operation\",\n            \"Scan\",\n            { \"label\"\
        : \"ReturnedItemCount\", \"id\": \"returneditemcount\" }\n          ]\n  \
        \      ],\n        \"period\": 300,\n        \"stat\": \"Sum\",\n        \"\
        region\": \"eu-central-1\",\n        \"title\": \"DynamoDB messages Metrics\"\
        \n      }\n    }\n  ]\n}\n"
