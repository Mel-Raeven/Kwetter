AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Resources:
  KwetterEventBus:
    Type: AWS::Events::EventBus
    Properties:
      Name: KwetterEventBus
  KwetterEventBusDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: KwetterEventBusDLQ
  KwetterEventBusDLQPolicy:
    Type: AWS::SQS::QueuePolicy
    Properties:
      Queues:
      - Ref: KwetterEventBusDLQ
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal: '*'
          Action: sqs:SendMessage
          Resource:
            Fn::GetAtt:
            - KwetterEventBusDLQ
            - Arn
          Condition:
            ArnEquals:
              aws:SourceArn:
                Fn::GetAtt:
                - KwetterEventBus
                - Arn
  KwetterEventBusmessageContentCheckingFunctionDLQRule:
    Type: AWS::Events::Rule
    Properties:
      Name: KwetterEventBusmessageContentCheckingFunctionDLQRule
      EventBusName:
        Ref: KwetterEventBus
      EventPattern:
        source:
        - com.example.kwetter
      Targets:
      - Id: KwetterEventBusDLQTarget
        Arn:
          Fn::GetAtt:
          - KwetterEventBusDLQ
          - Arn
        RetryPolicy:
          MaximumRetryAttempts: 1
          MaximumEventAgeInSeconds: 60
        DeadLetterConfig:
          Arn:
            Fn::GetAtt:
            - KwetterEventBusDLQ
            - Arn
  messageContentCheckingFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: go1.x
      SamResourceId: messageContentCheckingFunction
    Properties:
      CodeUri: messageContentCheckingFunction
      Handler: bootstrap
      Runtime: provided.al2
      Architectures:
      - arm64
      Role:
        Fn::GetAtt:
        - messageContentCheckingFunctionRole
        - Arn
  messageContentCheckingFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: lambda.amazonaws.com
          Action: sts:AssumeRole
      Policies:
      - PolicyName: LambdaLoggingPolicy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
            Resource: arn:aws:logs:*:*:*
      - PolicyName: EventBridgePutEventsPolicy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action: events:PutEvents
            Resource:
              Fn::GetAtt:
              - KwetterEventBus
              - Arn
      - PolicyName: DynamoDBReadPolicy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action: dynamodb:GetItem
            Resource:
              Fn::GetAtt:
              - KwetterMessagesDynamoDBTable
              - Arn
      - PolicyName: DynamoDBWritePolicy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action: dynamodb:PutItem
            Resource:
              Fn::GetAtt:
              - KwetterMessagesDynamoDBTable
              - Arn
  MessageCRUDFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: go1.x
      SamResourceId: MessageCRUDFunction
    Properties:
      CodeUri: MessageCRUDFunction
      Handler: bootstrap
      Runtime: provided.al2
      Architectures:
      - arm64
      Role:
        Fn::GetAtt:
        - MessageCRUDFunctionRole
        - Arn
  MessageCRUDFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: lambda.amazonaws.com
          Action: sts:AssumeRole
      Policies:
      - PolicyName: LambdaLoggingPolicy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
            Resource: arn:aws:logs:*:*:*
      - PolicyName: DynamoDBReadPolicy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action: dynamodb:GetItem
            Resource:
              Fn::GetAtt:
              - KwetterMessagesDynamoDBTable
              - Arn
      - PolicyName: DynamoDBWritePolicy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action: dynamodb:PutItem
            Resource:
              Fn::GetAtt:
              - KwetterMessagesDynamoDBTable
              - Arn
  KwetterMessagesDynamoDBTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: KwetterMessagesDynamoDBTable
      AttributeDefinitions:
      - AttributeName: GUID
        AttributeType: S
      KeySchema:
      - AttributeName: GUID
        KeyType: HASH
      ProvisionedThroughput:
        ReadCapacityUnits: 5
        WriteCapacityUnits: 5
  KwetterAPIGateway:
    Type: AWS::Serverless::Api
    Properties:
      StageName: Prod
      Cors: '''*'''
      DefinitionBody:
        swagger: '2.0'
        info:
          title: KwetterAPIGateway
        paths:
          /postMessage:
            post:
              consumes:
              - application/json
              produces:
              - application/json
              parameters: []
              responses: {}
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${messageContentCheckingFunction.Arn}/invocations
  KwetterUserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: KwetterUserPool
      DeletionProtection: ACTIVE
      Policies:
        PasswordPolicy:
          RequireLowercase: true
          RequireSymbols: false
          RequireNumbers: true
          MinimumLength: '8'
          RequireUppercase: true
      UsernameAttributes:
      - email
      Schema:
      - AttributeDataType: String
        Name: email
        Required: false
      AutoVerifiedAttributes:
      - email
  KwetterUserpoolDomain:
    Type: AWS::Cognito::UserPoolDomain
    Properties:
      UserPoolId:
        Ref: KwetterUserPool
      Domain: kwetter
  KwetterUserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      UserPoolId:
        Ref: KwetterUserPool
      ClientName: KwetterUserPoolClient
      GenerateSecret: false
      AllowedOAuthFlowsUserPoolClient: true
      AllowedOAuthFlows:
      - code
      CallbackURLs:
      - https://localhost:8000
      SupportedIdentityProviders:
      - COGNITO
      AllowedOAuthScopes:
      - phone
      - email
      - openid
  KwetterAPIGatewayPermissionTestFunction:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Fn::GetAtt:
        - messageContentCheckingFunction
        - Arn
      Principal: apigateway.amazonaws.com
  APIGatewayEventRule:
    Type: AWS::Events::Rule
    Properties:
      EventBusName:
        Ref: KwetterEventBus
      EventPattern:
        source:
        - api.gateway
        detail-type:
        - API Gateway Request
      Targets:
      - Arn:
          Fn::GetAtt:
          - messageContentCheckingFunction
          - Arn
        Id: InvokeTestFunction
  EventRulePermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Fn::GetAtt:
        - MessageCRUDFunction
        - Arn
      Principal: events.amazonaws.com
      SourceArn:
        Fn::GetAtt:
        - messageContentCheckingFunctionEventRule
        - Arn
  messageContentCheckingFunctionEventRule:
    Type: AWS::Events::Rule
    Properties:
      EventBusName:
        Ref: KwetterEventBus
      EventPattern:
        detail-type:
        - MessageCreation
      Targets:
      - Arn:
          Fn::GetAtt:
          - MessageCRUDFunction
          - Arn
        Id: MessageCRUDFunction
        RetryPolicy:
          MaximumRetryAttempts: 1
          MaximumEventAgeInSeconds: 60
        DeadLetterConfig:
          Arn:
            Fn::GetAtt:
            - KwetterEventBusDLQ
            - Arn
