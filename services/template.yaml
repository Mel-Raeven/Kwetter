AWSTemplateFormatVersion: '2010-09-09'
Transform: 'AWS::Serverless-2016-10-31'
Resources:
  KwetterEventBus: 
    Type: AWS::Events::EventBus
    Properties: 
      Name: !Sub "${AWS::StackName}-KwetterEventBus"

  KwetterEventBusDLQ:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: !Sub "${AWS::StackName}-KwetterEventBusDLQ"

  KwetterEventBusDLQPolicy:
    Type: AWS::SQS::QueuePolicy
    Properties:
      Queues:
        - !Ref KwetterEventBusDLQ
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal: "*"
            Action: "sqs:SendMessage"
            Resource: !GetAtt KwetterEventBusDLQ.Arn
            Condition:
              ArnEquals:
                aws:SourceArn: !GetAtt KwetterEventBus.Arn

  KwetterEventBusDLQRule:
    Type: AWS::Events::Rule
    Properties:
      Name: !Sub "${AWS::StackName}-KwetterEventBusDLQRule"
      EventBusName: !Ref KwetterEventBus
      EventPattern:
        source:
          - "com.example.kwetter"
      Targets:
        - Id: "KwetterEventBusDLQTarget"
          Arn: !GetAtt KwetterEventBusDLQ.Arn
          RetryPolicy:
            MaximumRetryAttempts: 1
            MaximumEventAgeInSeconds: 60
          DeadLetterConfig:
            Arn: !GetAtt KwetterEventBusDLQ.Arn

  messageContentCheckingFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: go1.x
    Properties:
      FunctionName: !Sub "${AWS::StackName}-MessageContentCheckingFunction"
      CodeUri: messages/lambda/messageContentChecking/
      Handler: bootstrap
      Runtime: provided.al2
      Architectures: [arm64]
      Role: !GetAtt messageContentCheckingFunctionRole.Arn

  messageContentCheckingFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: !Sub "${AWS::StackName}-LambdaLoggingPolicy"
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: arn:aws:logs:*:*:*
        - PolicyName: !Sub "${AWS::StackName}-EventBridgePutEventsPolicy"
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action: events:PutEvents
                Resource: !GetAtt KwetterEventBus.Arn

  DeleteUserFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: go1.x
    Properties:
      FunctionName: !Sub "${AWS::StackName}-DeleteUserFunction"
      CodeUri: auth/lambda/ForgetUser/
      Handler: bootstrap
      Runtime: provided.al2
      Architectures: [arm64]
      Role: !GetAtt DeleteUserFunctionRole.Arn

  DeleteUserFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: !Sub "${AWS::StackName}-CognitoDeleteUserPolicy"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - cognito-idp:AdminDeleteUser
                  - cognito-idp:GetUser
                Resource: !GetAtt KwetterUserPool.Arn 
        - PolicyName: !Sub "${AWS::StackName}-EventBridgePutEventsPolicy"
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action: events:PutEvents
                Resource: !GetAtt KwetterEventBus.Arn

  MessageCreateFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: go1.x
    Properties:
      FunctionName: !Sub "${AWS::StackName}-MessageCreateFunction"
      CodeUri: messages/lambda/messageCreate/
      Handler: bootstrap
      Runtime: provided.al2
      Architectures: [arm64]
      Role: !GetAtt MessageCreateFunctionRole.Arn

  MessageCreateFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: !Sub "${AWS::StackName}-LambdaLoggingPolicy"
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: arn:aws:logs:*:*:*
        - PolicyName: !Sub "${AWS::StackName}-DynamoDBWritePolicy"
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action: dynamodb:PutItem
                Resource: !GetAtt KwetterMessagesDynamoDBTable.Arn

  MessageDeleteBulkFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: go1.x
    Properties:
      FunctionName: !Sub "${AWS::StackName}-MessageDeleteBulkFunction"
      CodeUri: messages/lambda/messageDeleteBulk/
      Handler: bootstrap
      Runtime: provided.al2
      Architectures: [arm64]
      Role: !GetAtt MessageDeleteBulkFunctionRole.Arn

  MessageDeleteBulkFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: !Sub "${AWS::StackName}-LambdaLoggingPolicy"
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: arn:aws:logs:*:*:*
        - PolicyName: !Sub "${AWS::StackName}-DynamoDBWritePolicy"
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action: 
                  - 'dynamodb:DeleteItem'
                  - 'dynamodb:Scan'
                  - 'dynamodb:BatchWriteItem'
                Resource: !GetAtt KwetterMessagesDynamoDBTable.Arn

  MessageReadFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: go1.x
    Properties:
      FunctionName: !Sub "${AWS::StackName}-MessageReadFunction"
      CodeUri: messages/lambda/messageRead/
      Handler: bootstrap
      Runtime: provided.al2
      Architectures: [arm64]
      Role: !GetAtt MessageReadFunctionRole.Arn

  MessageReadFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: !Sub "${AWS::StackName}-LambdaDynamoDBPolicy"
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: 'Allow'
                Action:
                  - 'logs:CreateLogGroup'
                  - 'logs:CreateLogStream'
                  - 'logs:PutLogEvents'
                Resource: 'arn:aws:logs:*:*:*'
              - Effect: 'Allow'
                Action:
                  - 'dynamodb:Query'
                Resource: 
                  - !GetAtt KwetterMessagesDynamoDBTable.Arn

  KwetterMessagesDynamoDBTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${AWS::StackName}-KwetterMessagesDynamoDBTable"
      AttributeDefinitions:
        - AttributeName: "UserID"
          AttributeType: "S"
        - AttributeName: "GUID"
          AttributeType: "S"
      KeySchema:
        - AttributeName: "UserID"
          KeyType: "HASH"
        - AttributeName: "GUID"
          KeyType: "RANGE"
      ProvisionedThroughput:
        ReadCapacityUnits: 5
        WriteCapacityUnits: 5


    # Define the read capacity auto scaling policy
  ReadCapacityScalableTarget:
    Type: "AWS::ApplicationAutoScaling::ScalableTarget"
    Properties:
      MaxCapacity: 100
      MinCapacity: 5
      ResourceId: !Sub "table/${KwetterMessagesDynamoDBTable}"
      RoleARN: !GetAtt DynamoDBAutoScalingRole.Arn
      ScalableDimension: "dynamodb:table:ReadCapacityUnits"
      ServiceNamespace: "dynamodb"

  ReadCapacityScalingPolicy:
    Type: "AWS::ApplicationAutoScaling::ScalingPolicy"
    Properties:
      PolicyName: "ReadCapacityScalingPolicy"
      PolicyType: "TargetTrackingScaling"
      ScalingTargetId: !Ref ReadCapacityScalableTarget
      TargetTrackingScalingPolicyConfiguration:
        TargetValue: 70.0
        PredefinedMetricSpecification:
          PredefinedMetricType: "DynamoDBReadCapacityUtilization"
        ScaleInCooldown: 60
        ScaleOutCooldown: 60

  WriteCapacityScalableTarget:
    Type: "AWS::ApplicationAutoScaling::ScalableTarget"
    Properties:
      MaxCapacity: 5000
      MinCapacity: 5
      ResourceId: !Sub "table/${KwetterMessagesDynamoDBTable}"
      RoleARN: !GetAtt DynamoDBAutoScalingRole.Arn
      ScalableDimension: "dynamodb:table:WriteCapacityUnits"
      ServiceNamespace: "dynamodb"

  WriteCapacityScalingPolicy:
    Type: "AWS::ApplicationAutoScaling::ScalingPolicy"
    Properties:
      PolicyName: "WriteCapacityScalingPolicy"
      PolicyType: "TargetTrackingScaling"
      ScalingTargetId: !Ref WriteCapacityScalableTarget
      TargetTrackingScalingPolicyConfiguration:
        TargetValue: 70.0
        PredefinedMetricSpecification:
          PredefinedMetricType: "DynamoDBWriteCapacityUtilization"
        ScaleInCooldown: 0
        ScaleOutCooldown: 60

  DynamoDBAutoScalingRole:
    Type: "AWS::IAM::Role"
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Principal:
              Service: "application-autoscaling.amazonaws.com"
            Action: "sts:AssumeRole"
      Policies:
        - PolicyName: "DynamoDBAutoScalingPolicy"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: "Allow"
                Action:
                  - "dynamodb:DescribeTable"
                  - "dynamodb:UpdateTable"
                  - "cloudwatch:PutMetricAlarm"
                  - "cloudwatch:DescribeAlarms"
                  - "cloudwatch:GetMetricStatistics"
                  - "cloudwatch:SetAlarmState"
                  - "cloudwatch:DeleteAlarms"
                Resource: "*"
  
  KwetterAPIGateway:
    Type: AWS::Serverless::Api
    Properties:
      StageName: Prod
      Cors: "'*'"
      Auth:
        DefaultAuthorizer: CognitoAuthorizer
        Authorizers:
          CognitoAuthorizer:
            UserPoolArn: !Sub "arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/${KwetterUserPool}"
            Identity:
              Header: Authorization
      DefinitionBody:
        swagger: "2.0"
        info:
          title: "KwetterAPIGateway"
        paths:
            /postMessage:
              post:
                consumes:
                  - application/json
                produces:
                  - application/json
                parameters: []
                responses:
                  '200':
                    description: "200 response"
                x-amazon-apigateway-integration:
                  type: aws
                  httpMethod: POST
                  uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${messageContentCheckingFunction.Arn}/invocations"
                  passthroughBehavior: WHEN_NO_MATCH
                  responses:
                    default:
                      statusCode: '200'
                    4xx:
                      statusCode: '400'
                    5xx:
                      statusCode: '500'
            /getMessages/{userid}:
              get:
                consumes:
                  - application/json
                produces:
                  - application/json
                parameters:
                  - name: userid
                    in: path
                    required: true
                    type: string
                responses:
                  '200':
                    description: "200 response"
                x-amazon-apigateway-integration:
                  type: aws_proxy
                  httpMethod: GET
                  uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${MessageReadFunction.Arn}/invocations"
                  passthroughBehavior: WHEN_NO_MATCH
                  responses:
                    default:
                      statusCode: '200'
                    4xx:
                      statusCode: '400'
                    5xx:
                      statusCode: '500'
                  requestParameters:
                    integration.request.path.userid: method.request.path.userid
  
  OptionsMethodAuthorization:
    Type: AWS::ApiGateway::GatewayResponse
    Properties:
      ResponseParameters:
        gatewayresponse.header.Access-Control-Allow-Origin: "'*'"
        gatewayresponse.header.Access-Control-Allow-Methods: "'POST,OPTIONS'"
        gatewayresponse.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
        gatewayresponse.header.Access-Control-Expose-Headers: "'Last-Evaluated-Key'"
      ResponseType: DEFAULT_4XX
      RestApiId: !Ref KwetterAPIGateway
      StatusCode: 200

  KwetterUserPool:
    Type: AWS::Cognito::UserPool 
    Properties:
      UserPoolName: !Sub "${AWS::StackName}-KwetterUserPool"
      #DeletionProtection: ACTIVE 
      Policies:
        PasswordPolicy:
          RequireLowercase: true
          RequireSymbols: false
          RequireNumbers: true
          MinimumLength: "8"
          RequireUppercase: true
      UsernameAttributes:
        - email
      Schema:
        - AttributeDataType: String
          Name: email
          Required: false
      AutoVerifiedAttributes:
        - email

  KwetterUserpoolDomain:
    Type: AWS::Cognito::UserPoolDomain
    Properties:
      UserPoolId: !Ref KwetterUserPool
      Domain: !Sub "${AWS::StackName}"

  KwetterUserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      UserPoolId: !Ref KwetterUserPool
      ClientName: !Sub "${AWS::StackName}-KwetterUserPoolClient"
      GenerateSecret: false
      AllowedOAuthFlowsUserPoolClient: True
      AllowedOAuthFlows: 
        - code
        - implicit
      ExplicitAuthFlows:
        - "ALLOW_USER_PASSWORD_AUTH"
        - "ALLOW_REFRESH_TOKEN_AUTH"
        - "ALLOW_USER_SRP_AUTH"
      CallbackURLs: 
        - "http://localhost:5173/auth/callback"
      LogoutURLs:
        - "http://localhost:5173/"
      SupportedIdentityProviders:
        - COGNITO 
      AllowedOAuthScopes:
        - phone
        - email
        - openid
        - profile

  KwetterAPIGatewayPermissionMessageContentCheckingFunction:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt messageContentCheckingFunction.Arn
      Principal: apigateway.amazonaws.com
  
  KwetterAPIGatewayPermissionMessageReadFunction:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt MessageReadFunction.Arn
      Principal: apigateway.amazonaws.com
  
  APIGatewayMessageContentEventRule:
    Type: AWS::Events::Rule
    Properties:
      EventBusName: !Ref KwetterEventBus
      EventPattern:
        source:
          - "api.gateway"
        detail-type:
          - "API Gateway Request"
      Targets:
        - Arn: !GetAtt messageContentCheckingFunction.Arn
          Id: "InvokeTestFunction"
  
  APIGatewayMessageReadEventRule:
    Type: AWS::Events::Rule
    Properties:
      EventBusName: !Ref KwetterEventBus
      EventPattern:
        source:
          - "api.gateway"
        detail-type:
          - "API Gateway Request"
      Targets:
        - Arn: !GetAtt MessageReadFunction.Arn
          Id: "InvokeMessageReadFunction"

  EventRulePermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt MessageCreateFunction.Arn
      Principal: events.amazonaws.com
      SourceArn: !GetAtt messageContentCheckingFunctionEventRule.Arn

  messageContentCheckingFunctionEventRule:
    Type: AWS::Events::Rule
    Properties:
      EventBusName: !Ref KwetterEventBus # Replace with your event bus name
      EventPattern:
        detail-type:
          - "MessageCreation" # Replace with your detail type
      Targets:
        - Arn: !GetAtt MessageCreateFunction.Arn
          Id: "MessageCreateFunction"
          RetryPolicy:
            MaximumRetryAttempts: 4
            MaximumEventAgeInSeconds: 60
          DeadLetterConfig:
            Arn: !GetAtt KwetterEventBusDLQ.Arn

  messageDeleteBulkEventRulePermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt MessageDeleteBulkFunction.Arn
      Principal: events.amazonaws.com
      SourceArn: !GetAtt messageDeleteBulkFunctionEventRule.Arn

  messageDeleteBulkFunctionEventRule:
    Type: AWS::Events::Rule
    Properties:
      EventBusName: !Ref KwetterEventBus # Replace with your event bus name
      EventPattern:
        detail-type:
          - "DeleteUser" # Replace with your detail type
      Targets:
        - Arn: !GetAtt MessageDeleteBulkFunction.Arn
          Id: "MessageDeleteBulkFunction"
          RetryPolicy:
            MaximumRetryAttempts: 4
            MaximumEventAgeInSeconds: 120
          DeadLetterConfig:
            Arn: !GetAtt KwetterEventBusDLQ.Arn

  KwetterDashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName: !Sub "${AWS::StackName}-KwetterDashboard"
      DashboardBody: |
        {
          "widgets": [
            {
              "type": "metric",
              "x": 0,
              "y": 0,
              "width": 6,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "AWS/Lambda", "Errors", { "label": "Errors", "id": "errors" } ],
                  [ ".", "Invocations", { "label": "Invocations", "id": "invocations" } ],
                  [ ".", "Duration", { "label": "Duration", "id": "duration" } ]
                ],
                "period": 300,
                "stat": "Sum",
                "region": "eu-central-1",
                "title": "Lambda Metrics"
              }
            },
            {
              "type": "metric",
              "x": 6,
              "y": 0,
              "width": 6,
              "height": 6,
              "properties": {
                "metrics": [
                  [
                    "AWS/Cognito", 
                    "SignInSuccesses", 
                    "UserPool", 
                    "eu-central-1_sDUO5HFwX", 
                    "UserPoolClient", 
                    "5vs4anjqtme5f93037vv30fmp0", 
                    { "label": "SignInSuccesses", "id": "signinsuccesses" }
                  ],
                  [
                    "AWS/Cognito", 
                    "SignUpSuccesses", 
                    "UserPool", 
                    "eu-central-1_sDUO5HFwX", 
                    "UserPoolClient", 
                    "5vs4anjqtme5f93037vv30fmp0", 
                    { "label": "SignUpSuccesses", "id": "signupsuccesses" }
                  ]
                ],
                "period": 300,
                "stat": "Sum",
                "region": "eu-central-1",
                "title": "Cognito SignIn Metrics"
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 0,
              "width": 6,
              "height": 6,
              "properties": {
                "metrics": [
                  [
                    "AWS/ApiGateway", 
                    "Latency", 
                    "ApiName", 
                    "KwetterAPIGateway", 
                    { "label": "Latency", "id": "latency" }
                  ],
                  [
                    "AWS/ApiGateway",
                    "IntegrationLatency", 
                    "ApiName", 
                    "KwetterAPIGateway", 
                    { "label": "IntegrationLatency", "id": "integrationlatency" }
                  ]
                ],
                "period": 300,
                "stat": "Sum",
                "region": "eu-central-1",
                "title": "API gateway Metrics"
              }
            },
            {
              "type": "metric",
              "x": 18,
              "y": 0,
              "width": 6,
              "height": 6,
              "properties": {
                "metrics": [
                  [
                    "AWS/DynamoDB", 
                    "SuccessfulRequestLatency", 
                    "TableName", 
                    "KwetterMessagesDynamoDBTable",
                    "Operation",
                    "Scan",
                    { "label": "SuccessfulRequestLatency", "id": "successfulrequestlatency" }
                  ],
                  [
                    "AWS/DynamoDB", 
                    "ReturnedItemCount", 
                    "TableName", 
                    "KwetterMessagesDynamoDBTable",
                    "Operation",
                    "Scan",
                    { "label": "ReturnedItemCount", "id": "returneditemcount" }
                  ]
                ],
                "period": 300,
                "stat": "Sum",
                "region": "eu-central-1",
                "title": "DynamoDB messages Metrics"
              }
            }
          ]
        }

